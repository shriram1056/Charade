{"ast":null,"code":"import { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client';\nimport { WebSocketLink } from '@apollo/client/link/ws';\nimport { getMainDefinition } from '@apollo/client/utilities';\nimport cookieCutter from 'cookie-cutter';\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo';\nimport { useEffect, useMemo, useRef } from 'react';\nimport { SubscriptionClient } from 'subscriptions-transport-ws'; // ctx can be undefined in ssr:false, so we need optional\n\nconst createClient = ctx => // ctx for forwarding cookie in ssr\n{\n  var _ctx$req3;\n\n  const subscriptionClient = useRef(null); // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n\n  const Atoken = cookieCutter.get('access-token');\n  const Rtoken = cookieCutter.get('access-token');\n\n  if (false) {\n    useEffect(() => {\n      if (Atoken && Rtoken) {\n        if (subscriptionClient.current) {\n          subscriptionClient.current.close(); // if the userId has changed then close the current connection and open new one\n        }\n\n        subscriptionClient.current = new SubscriptionClient('ws://localhost:4001/subscriptions', {\n          reconnect: true,\n          connectionParams: {\n            authToken: {\n              Rtoken,\n              Atoken\n            }\n          },\n          lazy: true\n        });\n      }\n    }, [Atoken, Rtoken]);\n  } //WebSocket is a property that exists only in the browser\n\n\n  const wsLink = false ? new WebSocketLink({\n    uri: 'ws://localhost:4001/subscriptions',\n    options: {\n      reconnect: true,\n      connectionParams: {\n        authToken: {\n          Rtoken: cookieCutter.get('refresh-token'),\n          Atoken: cookieCutter.get('access-token')\n        }\n      },\n      lazy: true\n    }\n  }) : null;\n  const client = new ApolloClient({\n    cache: new InMemoryCache(),\n    ssrMode: true // Disables forceFetch on the server-side (so queries are only run once)\n\n  });\n  const splitLink = useMemo(() => {\n    var _ctx$req, _ctx$req2;\n\n    // useMemo: only recalculates a value if the elements in its dependency array change\n    const httpLink = new HttpLink({\n      uri: 'http://localhost:4001/graphql',\n      credentials: 'include',\n      //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n      headers: {\n        cookie: (true ? ctx === null || ctx === void 0 ? void 0 : (_ctx$req = ctx.req) === null || _ctx$req === void 0 ? void 0 : _ctx$req.headers.cookie : undefined) || ''\n      }\n    });\n\n    if (ctx !== null && ctx !== void 0 && (_ctx$req2 = ctx.req) !== null && _ctx$req2 !== void 0 && _ctx$req2.headers.cookie && subscriptionClient.current && false) {\n      const websocketLink = new WebSocketLink(subscriptionClient.current);\n      return split(({\n        query\n      }) => {\n        const definition = getMainDefinition(query);\n        return definition.kind === 'OperationDefinition' && definition.operation === 'subscription';\n      }, websocketLink, httpLink);\n    }\n\n    return httpLink;\n  }, [ctx === null || ctx === void 0 ? void 0 : (_ctx$req3 = ctx.req) === null || _ctx$req3 === void 0 ? void 0 : _ctx$req3.headers.cookie]);\n  useEffect(() => {\n    client.setLink(splitLink);\n  }, [splitLink]);\n  return client;\n};\n\nexport const withApollo = createWithApollo(createClient); //createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>","map":{"version":3,"sources":["/home/shriram/Downloads/slack clone/web/src/utils/withApollo.ts"],"names":["ApolloClient","HttpLink","InMemoryCache","split","WebSocketLink","getMainDefinition","cookieCutter","withApollo","createWithApollo","useEffect","useMemo","useRef","SubscriptionClient","createClient","ctx","subscriptionClient","Atoken","get","Rtoken","current","close","reconnect","connectionParams","authToken","lazy","wsLink","uri","options","client","cache","ssrMode","splitLink","httpLink","credentials","headers","cookie","req","undefined","websocketLink","query","definition","kind","operation","setLink"],"mappings":"AAAA,SAASA,YAAT,EAAuBC,QAAvB,EAAiCC,aAAjC,EAAgDC,KAAhD,QAA6D,gBAA7D;AACA,SAASC,aAAT,QAA8B,wBAA9B;AACA,SAASC,iBAAT,QAAkC,0BAAlC;AACA,OAAOC,YAAP,MAAyB,eAAzB;AAEA;AACA,SAASC,UAAU,IAAIC,gBAAvB,QAA+C,aAA/C;AACA,SAASC,SAAT,EAAoBC,OAApB,EAA6BC,MAA7B,QAA2C,OAA3C;AACA,SAASC,kBAAT,QAAmC,4BAAnC,C,CAEA;;AACA,MAAMC,YAAY,GAChBC,GADmB,IACG;AACnB;AAAA;;AACH,QAAMC,kBAAkB,GAAGJ,MAAM,CAAqB,IAArB,CAAjC,CADG,CACyD;;AAC5D,QAAMK,MAAM,GAAGV,YAAY,CAACW,GAAb,CAAiB,cAAjB,CAAf;AACA,QAAMC,MAAM,GAAGZ,YAAY,CAACW,GAAb,CAAiB,cAAjB,CAAf;;AAEA,aAAmC;AACjCR,IAAAA,SAAS,CAAC,MAAM;AACd,UAAIO,MAAM,IAAIE,MAAd,EAAsB;AACpB,YAAIH,kBAAkB,CAACI,OAAvB,EAAgC;AAC9BJ,UAAAA,kBAAkB,CAACI,OAAnB,CAA2BC,KAA3B,GAD8B,CACK;AACpC;;AACDL,QAAAA,kBAAkB,CAACI,OAAnB,GAA6B,IAAIP,kBAAJ,CAC3B,mCAD2B,EAE3B;AACES,UAAAA,SAAS,EAAE,IADb;AAEEC,UAAAA,gBAAgB,EAAE;AAChBC,YAAAA,SAAS,EAAE;AACTL,cAAAA,MADS;AAETF,cAAAA;AAFS;AADK,WAFpB;AAQEQ,UAAAA,IAAI,EAAE;AARR,SAF2B,CAA7B;AAaD;AACF,KAnBQ,EAmBN,CAACR,MAAD,EAASE,MAAT,CAnBM,CAAT;AAoBD,GA1BE,CA2BH;;;AACA,QAAMO,MAAM,GACV,QACI,IAAIrB,aAAJ,CAAkB;AAChBsB,IAAAA,GAAG,EAAE,mCADW;AAEhBC,IAAAA,OAAO,EAAE;AACPN,MAAAA,SAAS,EAAE,IADJ;AAEPC,MAAAA,gBAAgB,EAAE;AAChBC,QAAAA,SAAS,EAAE;AACTL,UAAAA,MAAM,EAAEZ,YAAY,CAACW,GAAb,CAAiB,eAAjB,CADC;AAETD,UAAAA,MAAM,EAAEV,YAAY,CAACW,GAAb,CAAiB,cAAjB;AAFC;AADK,OAFX;AAQPO,MAAAA,IAAI,EAAE;AARC;AAFO,GAAlB,CADJ,GAcI,IAfN;AAiBA,QAAMI,MAAM,GAAG,IAAI5B,YAAJ,CAAiB;AAC9B6B,IAAAA,KAAK,EAAE,IAAI3B,aAAJ,EADuB;AAE9B4B,IAAAA,OAAO,MAFuB,CAEU;;AAFV,GAAjB,CAAf;AAKA,QAAMC,SAAS,GAAGrB,OAAO,CAAC,MAAM;AAAA;;AAC9B;AACA,UAAMsB,QAAQ,GAAG,IAAI/B,QAAJ,CAAa;AAC5ByB,MAAAA,GAAG,EAAE,+BADuB;AAE5BO,MAAAA,WAAW,EAAE,SAFe;AAEJ;AACxBC,MAAAA,OAAO,EAAE;AACPC,QAAAA,MAAM,EACJ,CAAC,OACGrB,GADH,aACGA,GADH,mCACGA,GAAG,CAAEsB,GADR,6CACG,SAAUF,OAAV,CAAkBC,MADrB,GAEGE,SAFJ,KAEkB;AAJb;AAHmB,KAAb,CAAjB;;AAWA,QACEvB,GAAG,SAAH,IAAAA,GAAG,WAAH,iBAAAA,GAAG,CAAEsB,GAAL,gDAAUF,OAAV,CAAkBC,MAAlB,IACApB,kBAAkB,CAACI,OADnB,SADF,EAIE;AACA,YAAMmB,aAAa,GAAG,IAAIlC,aAAJ,CAAkBW,kBAAkB,CAACI,OAArC,CAAtB;AAEA,aAAOhB,KAAK,CACV,CAAC;AAAEoC,QAAAA;AAAF,OAAD,KAAe;AACb,cAAMC,UAAU,GAAGnC,iBAAiB,CAACkC,KAAD,CAApC;AACA,eACEC,UAAU,CAACC,IAAX,KAAoB,qBAApB,IACAD,UAAU,CAACE,SAAX,KAAyB,cAF3B;AAID,OAPS,EAQVJ,aARU,EASVN,QATU,CAAZ;AAWD;;AAED,WAAOA,QAAP;AACD,GAlCwB,EAkCtB,CAAClB,GAAD,aAACA,GAAD,oCAACA,GAAG,CAAEsB,GAAN,8CAAC,UAAUF,OAAV,CAAkBC,MAAnB,CAlCsB,CAAzB;AAoCA1B,EAAAA,SAAS,CAAC,MAAM;AACdmB,IAAAA,MAAM,CAACe,OAAP,CAAeZ,SAAf;AACD,GAFQ,EAEN,CAACA,SAAD,CAFM,CAAT;AAIA,SAAOH,MAAP;AACD,CA7FD;;AA8FA,OAAO,MAAMrB,UAAU,GAAGC,gBAAgB,CAACK,YAAD,CAAnC,C,CAEP","sourcesContent":["import { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client'\nimport { WebSocketLink } from '@apollo/client/link/ws'\nimport { getMainDefinition } from '@apollo/client/utilities'\nimport cookieCutter from 'cookie-cutter'\nimport { NextPageContext } from 'next'\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo'\nimport { useEffect, useMemo, useRef } from 'react'\nimport { SubscriptionClient } from 'subscriptions-transport-ws'\n\n// ctx can be undefined in ssr:false, so we need optional\nconst createClient = (\n  ctx?: NextPageContext // ctx for forwarding cookie in ssr\n) => {\n  const subscriptionClient = useRef<SubscriptionClient>(null) // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n  const Atoken = cookieCutter.get('access-token')\n  const Rtoken = cookieCutter.get('access-token')\n\n  if (typeof window !== 'undefined') {\n    useEffect(() => {\n      if (Atoken && Rtoken) {\n        if (subscriptionClient.current) {\n          subscriptionClient.current.close() // if the userId has changed then close the current connection and open new one\n        }\n        subscriptionClient.current = new SubscriptionClient(\n          'ws://localhost:4001/subscriptions',\n          {\n            reconnect: true,\n            connectionParams: {\n              authToken: {\n                Rtoken,\n                Atoken,\n              },\n            },\n            lazy: true,\n          }\n        )\n      }\n    }, [Atoken, Rtoken])\n  }\n  //WebSocket is a property that exists only in the browser\n  const wsLink =\n    typeof window !== 'undefined'\n      ? new WebSocketLink({\n          uri: 'ws://localhost:4001/subscriptions',\n          options: {\n            reconnect: true,\n            connectionParams: {\n              authToken: {\n                Rtoken: cookieCutter.get('refresh-token'),\n                Atoken: cookieCutter.get('access-token'),\n              },\n            },\n            lazy: true,\n          },\n        })\n      : null\n\n  const client = new ApolloClient({\n    cache: new InMemoryCache(),\n    ssrMode: typeof window === 'undefined', // Disables forceFetch on the server-side (so queries are only run once)\n  })\n\n  const splitLink = useMemo(() => {\n    // useMemo: only recalculates a value if the elements in its dependency array change\n    const httpLink = new HttpLink({\n      uri: 'http://localhost:4001/graphql',\n      credentials: 'include', //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n      headers: {\n        cookie:\n          (typeof window === 'undefined'\n            ? ctx?.req?.headers.cookie\n            : undefined) || '',\n      },\n    })\n\n    if (\n      ctx?.req?.headers.cookie &&\n      subscriptionClient.current &&\n      typeof window !== 'undefined'\n    ) {\n      const websocketLink = new WebSocketLink(subscriptionClient.current)\n\n      return split(\n        ({ query }) => {\n          const definition = getMainDefinition(query)\n          return (\n            definition.kind === 'OperationDefinition' &&\n            definition.operation === 'subscription'\n          )\n        },\n        websocketLink,\n        httpLink\n      )\n    }\n\n    return httpLink\n  }, [ctx?.req?.headers.cookie])\n\n  useEffect(() => {\n    client.setLink(splitLink)\n  }, [splitLink])\n\n  return client\n}\nexport const withApollo = createWithApollo(createClient)\n\n//createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>\n"]},"metadata":{},"sourceType":"module"}