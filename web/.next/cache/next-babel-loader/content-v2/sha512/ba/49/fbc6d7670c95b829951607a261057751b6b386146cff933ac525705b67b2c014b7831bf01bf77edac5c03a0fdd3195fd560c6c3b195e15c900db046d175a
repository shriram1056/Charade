{"ast":null,"code":"var _s = $RefreshSig$();\n\nimport { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client';\nimport { WebSocketLink } from '@apollo/client/link/ws';\nimport { getMainDefinition } from '@apollo/client/utilities';\nimport cookieCutter from 'cookie-cutter';\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo';\nimport { useEffect, useMemo, useRef } from 'react';\nimport { SubscriptionClient } from 'subscriptions-transport-ws';\nexport function useClient(userId) {} // ctx can be undefined in ssr:false, so we need optional\n\nvar createClient = function createClient(ctx) // ctx for forwarding cookie in ssr\n{\n  _s();\n\n  var _ctx$req, _ctx$req6;\n\n  var subscriptionClient = useRef(null); // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n\n  console.log(ctx === null || ctx === void 0 ? void 0 : (_ctx$req = ctx.req) === null || _ctx$req === void 0 ? void 0 : _ctx$req.headers.cookie);\n\n  if (true) {\n    var _ctx$req3;\n\n    useEffect(function () {\n      var _ctx$req2;\n\n      if (ctx !== null && ctx !== void 0 && (_ctx$req2 = ctx.req) !== null && _ctx$req2 !== void 0 && _ctx$req2.headers.cookie) {\n        if (subscriptionClient.current) {\n          subscriptionClient.current.close(); // if the userId has changed then close the current connection and open new one\n        }\n\n        subscriptionClient.current = new SubscriptionClient('ws://localhost:4001/subscriptions', {\n          reconnect: true,\n          connectionParams: {\n            authToken: {\n              Rtoken: cookieCutter.get('refresh-token'),\n              Atoken: cookieCutter.get('access-token')\n            }\n          },\n          lazy: true\n        });\n      }\n    }, [ctx === null || ctx === void 0 ? void 0 : (_ctx$req3 = ctx.req) === null || _ctx$req3 === void 0 ? void 0 : _ctx$req3.headers.cookie]);\n  } //WebSocket is a property that exists only in the browser\n\n\n  var wsLink = true ? new WebSocketLink({\n    uri: 'ws://localhost:4001/subscriptions',\n    options: {\n      reconnect: true,\n      connectionParams: {\n        authToken: {\n          Rtoken: cookieCutter.get('refresh-token'),\n          Atoken: cookieCutter.get('access-token')\n        }\n      },\n      lazy: true\n    }\n  }) : null;\n  var client = new ApolloClient({\n    cache: new InMemoryCache(),\n    ssrMode: false // Disables forceFetch on the server-side (so queries are only run once)\n\n  });\n  var splitLink = useMemo(function () {\n    var _ctx$req4, _ctx$req5;\n\n    // useMemo: only recalculates a value if the elements in its dependency array change\n    var httpLink = new HttpLink({\n      uri: 'http://localhost:4001/graphql',\n      credentials: 'include',\n      //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n      headers: {\n        cookie: (false ? ctx === null || ctx === void 0 ? void 0 : (_ctx$req4 = ctx.req) === null || _ctx$req4 === void 0 ? void 0 : _ctx$req4.headers.cookie : undefined) || ''\n      }\n    });\n\n    if (ctx !== null && ctx !== void 0 && (_ctx$req5 = ctx.req) !== null && _ctx$req5 !== void 0 && _ctx$req5.headers.cookie && subscriptionClient.current && true) {\n      var websocketLink = new WebSocketLink(subscriptionClient.current);\n      return split(function (_ref) {\n        var query = _ref.query;\n        var definition = getMainDefinition(query);\n        return definition.kind === 'OperationDefinition' && definition.operation === 'subscription';\n      }, websocketLink, httpLink);\n    }\n\n    return httpLink;\n  }, [ctx === null || ctx === void 0 ? void 0 : (_ctx$req6 = ctx.req) === null || _ctx$req6 === void 0 ? void 0 : _ctx$req6.headers.cookie]);\n  useEffect(function () {\n    client.setLink(splitLink);\n  }, [splitLink]);\n  return client;\n};\n\n_s(createClient, \"C6r8MFGYx7d59pohIgwRhS/g3ME=\");\n\nexport var withApollo = createWithApollo(createClient); //createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>","map":{"version":3,"sources":["/home/shriram/Downloads/slack clone/web/src/utils/withApollo.ts"],"names":["ApolloClient","HttpLink","InMemoryCache","split","WebSocketLink","getMainDefinition","cookieCutter","withApollo","createWithApollo","useEffect","useMemo","useRef","SubscriptionClient","useClient","userId","createClient","ctx","subscriptionClient","console","log","req","headers","cookie","current","close","reconnect","connectionParams","authToken","Rtoken","get","Atoken","lazy","wsLink","uri","options","client","cache","ssrMode","splitLink","httpLink","credentials","undefined","websocketLink","query","definition","kind","operation","setLink"],"mappings":"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","sourcesContent":["import { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client'\nimport { WebSocketLink } from '@apollo/client/link/ws'\nimport { getMainDefinition } from '@apollo/client/utilities'\nimport cookieCutter from 'cookie-cutter'\nimport { NextPageContext } from 'next'\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo'\nimport { useEffect, useMemo, useRef } from 'react'\nimport { SubscriptionClient } from 'subscriptions-transport-ws'\n\nexport function useClient(userId: string) {}\n// ctx can be undefined in ssr:false, so we need optional\nconst createClient = (\n  ctx?: NextPageContext // ctx for forwarding cookie in ssr\n) => {\n  const subscriptionClient = useRef<SubscriptionClient>(null) // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n  console.log(ctx?.req?.headers.cookie)\n  if (typeof window !== 'undefined') {\n    useEffect(() => {\n      if (ctx?.req?.headers.cookie) {\n        if (subscriptionClient.current) {\n          subscriptionClient.current.close() // if the userId has changed then close the current connection and open new one\n        }\n        subscriptionClient.current = new SubscriptionClient(\n          'ws://localhost:4001/subscriptions',\n          {\n            reconnect: true,\n            connectionParams: {\n              authToken: {\n                Rtoken: cookieCutter.get('refresh-token'),\n                Atoken: cookieCutter.get('access-token'),\n              },\n            },\n            lazy: true,\n          }\n        )\n      }\n    }, [ctx?.req?.headers.cookie])\n  }\n  //WebSocket is a property that exists only in the browser\n  const wsLink =\n    typeof window !== 'undefined'\n      ? new WebSocketLink({\n          uri: 'ws://localhost:4001/subscriptions',\n          options: {\n            reconnect: true,\n            connectionParams: {\n              authToken: {\n                Rtoken: cookieCutter.get('refresh-token'),\n                Atoken: cookieCutter.get('access-token'),\n              },\n            },\n            lazy: true,\n          },\n        })\n      : null\n\n  const client = new ApolloClient({\n    cache: new InMemoryCache(),\n    ssrMode: typeof window === 'undefined', // Disables forceFetch on the server-side (so queries are only run once)\n  })\n\n  const splitLink = useMemo(() => {\n    // useMemo: only recalculates a value if the elements in its dependency array change\n    const httpLink = new HttpLink({\n      uri: 'http://localhost:4001/graphql',\n      credentials: 'include', //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n      headers: {\n        cookie:\n          (typeof window === 'undefined'\n            ? ctx?.req?.headers.cookie\n            : undefined) || '',\n      },\n    })\n\n    if (\n      ctx?.req?.headers.cookie &&\n      subscriptionClient.current &&\n      typeof window !== 'undefined'\n    ) {\n      const websocketLink = new WebSocketLink(subscriptionClient.current)\n\n      return split(\n        ({ query }) => {\n          const definition = getMainDefinition(query)\n          return (\n            definition.kind === 'OperationDefinition' &&\n            definition.operation === 'subscription'\n          )\n        },\n        websocketLink,\n        httpLink\n      )\n    }\n\n    return httpLink\n  }, [ctx?.req?.headers.cookie])\n\n  useEffect(() => {\n    client.setLink(splitLink)\n  }, [splitLink])\n\n  return client\n}\nexport const withApollo = createWithApollo(createClient)\n\n//createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>\n"]},"metadata":{},"sourceType":"module"}