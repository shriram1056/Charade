{"ast":null,"code":"var _ctx5, _ctx5$req;\n\nimport { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client';\nimport { WebSocketLink } from '@apollo/client/link/ws';\nimport { getMainDefinition } from '@apollo/client/utilities';\nimport cookieCutter from 'cookie-cutter';\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo';\nimport { useEffect, useMemo, useRef } from 'react';\nimport { SubscriptionClient } from 'subscriptions-transport-ws';\nexport function useClient(userId) {} // ctx can be undefined in ssr:false, so we need optional\n\nconst createClient = ctx => // ctx for forwarding cookie in ssr\n{\n  var _ctx$req;\n\n  const httpLink = new HttpLink({\n    uri: 'http://localhost:4001/graphql',\n    credentials: 'include',\n    //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n    headers: {\n      cookie: (true ? ctx === null || ctx === void 0 ? void 0 : (_ctx$req = ctx.req) === null || _ctx$req === void 0 ? void 0 : _ctx$req.headers.cookie : undefined) || ''\n    }\n  }); //WebSocket is a property that exists only in the browser\n\n  const wsLink = false ? new WebSocketLink({\n    uri: 'ws://localhost:4001/subscriptions',\n    options: {\n      reconnect: true,\n      connectionParams: {\n        authToken: {\n          Rtoken: cookieCutter.get('refresh-token'),\n          Atoken: cookieCutter.get('access-token')\n        }\n      },\n      lazy: true\n    }\n  }) : null;\n  const splitLink = false ? split(({\n    query\n  }) => {\n    const definition = getMainDefinition(query);\n    return definition.kind === 'OperationDefinition' && definition.operation === 'subscription';\n  }, wsLink, httpLink) : httpLink; // this should be http link becuase in server, we use http and in client we use both http and sockets\n\n  return new ApolloClient({\n    link: splitLink,\n    //link option, it takes precedence over the uri option (uri sets up a default HTTP link chain using the provided URL).\n    cache: new InMemoryCache(),\n    ssrMode: true // Disables forceFetch on the server-side (so queries are only run once)\n\n  }); //WebSocket is a property that exists only in the browser\n};\n\nexport const withApollo = createWithApollo(createClient); //createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>\n\nconst client = new ApolloClient({\n  //link option, it takes precedence over the uri option (uri sets up a default HTTP link chain using the provided URL).\n  cache: new InMemoryCache(),\n  ssrMode: true // Disables forceFetch on the server-side (so queries are only run once)\n\n});\nconst subscriptionClient = useRef(null); // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n\nif (false) {\n  var _ctx2, _ctx2$req;\n\n  useEffect(() => {\n    var _ctx, _ctx$req2;\n\n    if ((_ctx = ctx) !== null && _ctx !== void 0 && (_ctx$req2 = _ctx.req) !== null && _ctx$req2 !== void 0 && _ctx$req2.headers.cookie) {\n      if (subscriptionClient.current) {\n        subscriptionClient.current.close(); // if the userId has changed then close the current connection and open new one\n      }\n\n      subscriptionClient.current = new SubscriptionClient('ws://localhost:4001/subscriptions', {\n        reconnect: true,\n        connectionParams: {\n          authToken: {\n            Rtoken: cookieCutter.get('refresh-token'),\n            Atoken: cookieCutter.get('access-token')\n          }\n        },\n        lazy: true\n      });\n    }\n  }, [(_ctx2 = ctx) === null || _ctx2 === void 0 ? void 0 : (_ctx2$req = _ctx2.req) === null || _ctx2$req === void 0 ? void 0 : _ctx2$req.headers.cookie]);\n}\n\nconst splitLink = useMemo(() => {\n  var _ctx3, _ctx3$req, _ctx4, _ctx4$req;\n\n  // useMemo: only recalculates a value if the elements in its dependency array change\n  const httpLink = new HttpLink({\n    uri: 'http://localhost:4001/graphql',\n    credentials: 'include',\n    //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n    headers: {\n      cookie: (true ? (_ctx3 = ctx) === null || _ctx3 === void 0 ? void 0 : (_ctx3$req = _ctx3.req) === null || _ctx3$req === void 0 ? void 0 : _ctx3$req.headers.cookie : undefined) || ''\n    }\n  });\n\n  if ((_ctx4 = ctx) !== null && _ctx4 !== void 0 && (_ctx4$req = _ctx4.req) !== null && _ctx4$req !== void 0 && _ctx4$req.headers.cookie && subscriptionClient.current && false) {\n    const websocketLink = new WebSocketLink(subscriptionClient.current);\n    return split(({\n      query\n    }) => {\n      const definition = getMainDefinition(query);\n      return definition.kind === 'OperationDefinition' && definition.operation === 'subscription';\n    }, websocketLink, httpLink);\n  }\n\n  return httpLink;\n}, [(_ctx5 = ctx) === null || _ctx5 === void 0 ? void 0 : (_ctx5$req = _ctx5.req) === null || _ctx5$req === void 0 ? void 0 : _ctx5$req.headers.cookie]);\nuseEffect(() => {\n  client.setLink(splitLink);\n}, [splitLink]);","map":{"version":3,"sources":["/home/shriram/Downloads/slack clone/web/src/utils/withApollo.ts"],"names":["ApolloClient","HttpLink","InMemoryCache","split","WebSocketLink","getMainDefinition","cookieCutter","withApollo","createWithApollo","useEffect","useMemo","useRef","SubscriptionClient","useClient","userId","createClient","ctx","httpLink","uri","credentials","headers","cookie","req","undefined","wsLink","options","reconnect","connectionParams","authToken","Rtoken","get","Atoken","lazy","splitLink","query","definition","kind","operation","link","cache","ssrMode","client","subscriptionClient","current","close","websocketLink","setLink"],"mappings":"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","sourcesContent":["import { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client'\nimport { WebSocketLink } from '@apollo/client/link/ws'\nimport { getMainDefinition } from '@apollo/client/utilities'\nimport cookieCutter from 'cookie-cutter'\nimport { NextPageContext } from 'next'\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo'\nimport { useEffect, useMemo, useRef } from 'react'\nimport { SubscriptionClient } from 'subscriptions-transport-ws'\n\nexport function useClient(userId: string) {}\n// ctx can be undefined in ssr:false, so we need optional\nconst createClient = (\n  ctx?: NextPageContext // ctx for forwarding cookie in ssr\n) => {\n  const httpLink = new HttpLink({\n    uri: 'http://localhost:4001/graphql',\n    credentials: 'include', //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n    headers: {\n      cookie:\n        (typeof window === 'undefined'\n          ? ctx?.req?.headers.cookie\n          : undefined) || '',\n    },\n  })\n\n  //WebSocket is a property that exists only in the browser\n  const wsLink =\n    typeof window !== 'undefined'\n      ? new WebSocketLink({\n          uri: 'ws://localhost:4001/subscriptions',\n          options: {\n            reconnect: true,\n            connectionParams: {\n              authToken: {\n                Rtoken: cookieCutter.get('refresh-token'),\n                Atoken: cookieCutter.get('access-token'),\n              },\n            },\n            lazy: true,\n          },\n        })\n      : null\n\n  const splitLink =\n    typeof window !== 'undefined'\n      ? split(\n          ({ query }) => {\n            const definition = getMainDefinition(query)\n            return (\n              definition.kind === 'OperationDefinition' &&\n              definition.operation === 'subscription'\n            )\n          },\n          wsLink,\n          httpLink\n        )\n      : httpLink // this should be http link becuase in server, we use http and in client we use both http and sockets\n\n  return new ApolloClient({\n    link: splitLink, //link option, it takes precedence over the uri option (uri sets up a default HTTP link chain using the provided URL).\n    cache: new InMemoryCache(),\n    ssrMode: typeof window === 'undefined', // Disables forceFetch on the server-side (so queries are only run once)\n  })\n  //WebSocket is a property that exists only in the browser\n}\nexport const withApollo = createWithApollo(createClient)\n\n//createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>\n\nconst client = new ApolloClient({\n  //link option, it takes precedence over the uri option (uri sets up a default HTTP link chain using the provided URL).\n  cache: new InMemoryCache(),\n  ssrMode: typeof window === 'undefined', // Disables forceFetch on the server-side (so queries are only run once)\n})\n\nconst subscriptionClient = useRef<SubscriptionClient>(null) // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n\nif (typeof window !== 'undefined') {\n  useEffect(() => {\n    if (ctx?.req?.headers.cookie) {\n      if (subscriptionClient.current) {\n        subscriptionClient.current.close() // if the userId has changed then close the current connection and open new one\n      }\n      subscriptionClient.current = new SubscriptionClient(\n        'ws://localhost:4001/subscriptions',\n        {\n          reconnect: true,\n          connectionParams: {\n            authToken: {\n              Rtoken: cookieCutter.get('refresh-token'),\n              Atoken: cookieCutter.get('access-token'),\n            },\n          },\n          lazy: true,\n        }\n      )\n    }\n  }, [ctx?.req?.headers.cookie])\n}\n\nconst splitLink = useMemo(() => {\n  // useMemo: only recalculates a value if the elements in its dependency array change\n  const httpLink = new HttpLink({\n    uri: 'http://localhost:4001/graphql',\n    credentials: 'include', //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n    headers: {\n      cookie:\n        (typeof window === 'undefined'\n          ? ctx?.req?.headers.cookie\n          : undefined) || '',\n    },\n  })\n\n  if (\n    ctx?.req?.headers.cookie &&\n    subscriptionClient.current &&\n    typeof window !== 'undefined'\n  ) {\n    const websocketLink = new WebSocketLink(subscriptionClient.current)\n\n    return split(\n      ({ query }) => {\n        const definition = getMainDefinition(query)\n        return (\n          definition.kind === 'OperationDefinition' &&\n          definition.operation === 'subscription'\n        )\n      },\n      websocketLink,\n      httpLink\n    )\n  }\n\n  return httpLink\n}, [ctx?.req?.headers.cookie])\n\nuseEffect(() => {\n  client.setLink(splitLink)\n}, [splitLink])\n"]},"metadata":{},"sourceType":"module"}