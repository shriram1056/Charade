{"ast":null,"code":"import { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client';\nimport { WebSocketLink } from '@apollo/client/link/ws';\nimport { getMainDefinition } from '@apollo/client/utilities';\nimport cookieCutter from 'cookie-cutter';\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo';\nimport { useEffect, useMemo, useRef } from 'react';\nimport { SubscriptionClient } from 'subscriptions-transport-ws';\nexport function useClient(userId) {} // ctx can be undefined in ssr:false, so we need optional\n\nconst createClient = ctx => // ctx for forwarding cookie in ssr\n{\n  var _ctx$req5;\n\n  const client = new ApolloClient({\n    //link option, it takes precedence over the uri option (uri sets up a default HTTP link chain using the provided URL).\n    cache: new InMemoryCache(),\n    ssrMode: true // Disables forceFetch on the server-side (so queries are only run once)\n\n  });\n  const subscriptionClient = useRef(null); // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n\n  if (false) {\n    var _ctx$req2;\n\n    useEffect(() => {\n      var _ctx$req;\n\n      if (ctx !== null && ctx !== void 0 && (_ctx$req = ctx.req) !== null && _ctx$req !== void 0 && _ctx$req.headers.cookie) {\n        if (subscriptionClient.current) {\n          subscriptionClient.current.close(); // if the userId has changed then close the current connection and open new one\n        }\n\n        subscriptionClient.current = new SubscriptionClient('ws://localhost:4001/subscriptions', {\n          reconnect: true,\n          connectionParams: {\n            authToken: {\n              Rtoken: cookieCutter.get('refresh-token'),\n              Atoken: cookieCutter.get('access-token')\n            }\n          },\n          lazy: true\n        });\n      }\n    }, [ctx === null || ctx === void 0 ? void 0 : (_ctx$req2 = ctx.req) === null || _ctx$req2 === void 0 ? void 0 : _ctx$req2.headers.cookie]);\n  }\n\n  const splitLink = useMemo(() => {\n    var _ctx$req3, _ctx$req4;\n\n    // useMemo: only recalculates a value if the elements in its dependency array change\n    const httpLink = new HttpLink({\n      uri: 'http://localhost:4001/graphql',\n      credentials: 'include',\n      //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n      headers: {\n        cookie: (true ? ctx === null || ctx === void 0 ? void 0 : (_ctx$req3 = ctx.req) === null || _ctx$req3 === void 0 ? void 0 : _ctx$req3.headers.cookie : undefined) || ''\n      }\n    });\n\n    if (ctx !== null && ctx !== void 0 && (_ctx$req4 = ctx.req) !== null && _ctx$req4 !== void 0 && _ctx$req4.headers.cookie && subscriptionClient.current && false) {\n      const websocketLink = new WebSocketLink(subscriptionClient.current);\n      return split(({\n        query\n      }) => {\n        const definition = getMainDefinition(query);\n        return definition.kind === 'OperationDefinition' && definition.operation === 'subscription';\n      }, websocketLink, httpLink);\n    }\n\n    return httpLink;\n  }, [ctx === null || ctx === void 0 ? void 0 : (_ctx$req5 = ctx.req) === null || _ctx$req5 === void 0 ? void 0 : _ctx$req5.headers.cookie]);\n  useEffect(() => {\n    client.setLink(splitLink);\n  }, [splitLink]);\n  return client; //WebSocket is a property that exists only in the browser\n};\n\nexport const withApollo = createWithApollo(createClient); //createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>","map":{"version":3,"sources":["/home/shriram/Downloads/slack clone/web/src/utils/withApollo.ts"],"names":["ApolloClient","HttpLink","InMemoryCache","split","WebSocketLink","getMainDefinition","cookieCutter","withApollo","createWithApollo","useEffect","useMemo","useRef","SubscriptionClient","useClient","userId","createClient","ctx","client","cache","ssrMode","subscriptionClient","req","headers","cookie","current","close","reconnect","connectionParams","authToken","Rtoken","get","Atoken","lazy","splitLink","httpLink","uri","credentials","undefined","websocketLink","query","definition","kind","operation","setLink"],"mappings":"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","sourcesContent":["import { ApolloClient, HttpLink, InMemoryCache, split } from '@apollo/client'\nimport { WebSocketLink } from '@apollo/client/link/ws'\nimport { getMainDefinition } from '@apollo/client/utilities'\nimport cookieCutter from 'cookie-cutter'\nimport { NextPageContext } from 'next'\n// this import is for forwarding the cookie\nimport { withApollo as createWithApollo } from 'next-apollo'\nimport { useEffect, useMemo, useRef } from 'react'\nimport { SubscriptionClient } from 'subscriptions-transport-ws'\n\nexport function useClient(userId: string) {}\n// ctx can be undefined in ssr:false, so we need optional\nconst createClient = (\n  ctx?: NextPageContext // ctx for forwarding cookie in ssr\n) => {\n  const client = new ApolloClient({\n    //link option, it takes precedence over the uri option (uri sets up a default HTTP link chain using the provided URL).\n    cache: new InMemoryCache(),\n    ssrMode: typeof window === 'undefined', // Disables forceFetch on the server-side (so queries are only run once)\n  })\n\n  const subscriptionClient = useRef<SubscriptionClient>(null) // remebers state without re-render.useRef returns a mutable ref object whose .current property is initialized to the passed argument (initialValue)\n\n  if (typeof window !== 'undefined') {\n    useEffect(() => {\n      if (ctx?.req?.headers.cookie) {\n        if (subscriptionClient.current) {\n          subscriptionClient.current.close() // if the userId has changed then close the current connection and open new one\n        }\n        subscriptionClient.current = new SubscriptionClient(\n          'ws://localhost:4001/subscriptions',\n          {\n            reconnect: true,\n            connectionParams: {\n              authToken: {\n                Rtoken: cookieCutter.get('refresh-token'),\n                Atoken: cookieCutter.get('access-token'),\n              },\n            },\n            lazy: true,\n          }\n        )\n      }\n    }, [ctx?.req?.headers.cookie])\n  }\n\n  const splitLink = useMemo(() => {\n    // useMemo: only recalculates a value if the elements in its dependency array change\n    const httpLink = new HttpLink({\n      uri: 'http://localhost:4001/graphql',\n      credentials: 'include', //Apollo Client can include user credentials (basic auth, cookies, etc.) in the HTTP requests it makes to a GraphQL server. By default, credentials are included only if the server is hosted at the same origin as the application using Apollo Client.also, set credentials to true in cors package in express\n      headers: {\n        cookie:\n          (typeof window === 'undefined'\n            ? ctx?.req?.headers.cookie\n            : undefined) || '',\n      },\n    })\n\n    if (\n      ctx?.req?.headers.cookie &&\n      subscriptionClient.current &&\n      typeof window !== 'undefined'\n    ) {\n      const websocketLink = new WebSocketLink(subscriptionClient.current)\n\n      return split(\n        ({ query }) => {\n          const definition = getMainDefinition(query)\n          return (\n            definition.kind === 'OperationDefinition' &&\n            definition.operation === 'subscription'\n          )\n        },\n        websocketLink,\n        httpLink\n      )\n    }\n\n    return httpLink\n  }, [ctx?.req?.headers.cookie])\n\n  useEffect(() => {\n    client.setLink(splitLink)\n  }, [splitLink])\n\n  return client\n  //WebSocket is a property that exists only in the browser\n}\nexport const withApollo = createWithApollo(createClient)\n\n//createWithApollo takes a ApolloClient<NormalizedCacheObject> | ((ctx?: NextPageContext) => ApolloClient<NormalizedCacheObject>); your createClient is of type (ctx: NextPageContext) => ApolloClient<NormalizedCacheObject>\n"]},"metadata":{},"sourceType":"module"}